// schema.prisma - Complete Database with Visitor Tracking + Employee System + CMS + Approvals

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum Role {
  SUPERADMIN
  ADMIN
  EMPLOYEE
}

enum InterviewStatus {
  PENDING
  SCHEDULED
  COMPLETED
  APPROVED
  REJECTED
}

enum EmploymentStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  TERMINATED
}

enum ContentType {
  ARTICLE
  NEWS
  BLOG
  ANNOUNCEMENT
  EVENT
  GALLERY
  VIDEO
  PAGE
  PROJECT
}

enum ContentStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  SCHEDULED
  REVIEW
}

enum MediaType {
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum ApprovalType {
  EXPENSE_CLAIM
  USER_ACCESS
  CONTENT_PUBLISH
  PURCHASE_ORDER
  LEAVE_REQUEST
  BUDGET_INCREASE
  EQUIPMENT_REQUEST
  TRAINING_REQUEST
  OTHER
}

enum ApprovalPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TrackingStatus {
  ONLINE
  OFFLINE
  BREAK
  IDLE
}

enum VisitorType {
  ANONYMOUS      // Not identified yet
  IDENTIFIED     // Has provided info (email, name, etc)
  REGISTERED     // Registered user
  LEAD           // Potential customer
  CUSTOMER       // Existing customer
}

enum VisitorStatus {
  ACTIVE         // Currently on site
  IDLE           // Inactive for 5+ minutes
  LEFT           // Left the site
  CONVERTED      // Became a lead/customer
}

// ==================== USER & EMPLOYEE MODELS ====================

model User {
  id                      String           @id @default(uuid())
  email                   String           @unique
  password                String
  firstName               String
  lastName                String
  phone                   String?
  avatar                  String?
  role                    Role             @default(EMPLOYEE)
  status                  EmploymentStatus @default(INACTIVE)
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt
  createdBy               String?
  
  // Employee Relations
  employee                Employee?
  employeesHired          Employee[]       @relation("EmployeeHirer")
  interviewsAsCandidiate  Interview[]      @relation("CandidateInterviews")
  interviewsAsInterviewer Interview[]      @relation("InterviewerInterviews")
  
  // CMS Relations
  content                 Content[]        @relation("ContentAuthor")
  media                   Media[]          @relation("MediaUploader")
  comments                Comment[]        @relation("CommentAuthor")
  contentLikes            ContentLike[]
  
  // Approval Relations
  submittedApprovals      Approval[]       @relation("ApprovalSubmitter")
  approvedApprovals       Approval[]       @relation("ApprovalApprover")
  approvalComments        ApprovalComment[]
  approvalHistory         ApprovalHistory[]

  // Employee Tracking Relations
  employeeTracking        EmployeeTracking[]
  workSessions            WorkSession[]
  submittedActivityLogs   AdminActivityLog[] @relation("ActivitySubmitter")
  
  @@map("users")
}

model Employee {
  id          String               @id @default(uuid())
  userId      String               @unique
  employeeId  String               @unique
  department  String
  position    String
  location    String?
  joinDate    DateTime
  status      EmploymentStatus     @default(ACTIVE)
  salary      Float?
  hiredById   String?
  hiredAt     DateTime?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  
  // Performance metrics
  performanceRating Float?
  attendanceRate    Float?
  totalHoursMonth   Float?
  
  // Relations
  user        User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  hiredBy     User?                @relation("EmployeeHirer", fields: [hiredById], references: [id])
  termination EmployeeTermination?

  @@map("employees")
}

model EmployeeTermination {
  id           String   @id @default(uuid())
  employeeId   String   @unique
  reason       String
  terminatedAt DateTime @default(now())
  terminatedBy String?
  notes        String?
  createdAt    DateTime @default(now())
  
  // Relations
  employee     Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@map("employee_terminations")
}

model Interview {
  id            String          @id @default(uuid())
  candidateId   String
  interviewerId String?
  position      String
  division      String
  status        InterviewStatus @default(PENDING)
  scheduledAt   DateTime?
  notes         String?
  feedback      String?
  approvedBy    String?
  approvedAt    DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  // Relations
  candidate     User            @relation("CandidateInterviews", fields: [candidateId], references: [id], onDelete: Cascade)
  interviewer   User?           @relation("InterviewerInterviews", fields: [interviewerId], references: [id])

  @@map("interviews")
}

// ==================== EMPLOYEE TRACKING SYSTEM ====================

model EmployeeTracking {
  id                String         @id @default(cuid())
  userId            String
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  employeeId        String
  email             String
  department        String
  position          String?
  
  loginTime         DateTime       @default(now())
  logoutTime        DateTime?
  status            TrackingStatus @default(ONLINE)
  workDurationHours Float?
  
  // Device & Location info
  ipAddress         String?
  deviceInfo        String?
  location          String?
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([userId])
  @@index([employeeId])
  @@index([status])
  @@index([email])
  @@index([loginTime])
  @@map("employee_tracking")
}

model WorkSession {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  employeeId       String
  email            String
  department       String
  
  loginTime        DateTime
  logoutTime       DateTime
  durationHours    Float
  date             DateTime
  
  breakDuration    Float?   @default(0)
  tasksCompleted   Int?
  productivity     Float?   // percentage
  notes            String?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([userId])
  @@index([employeeId])
  @@index([email])
  @@index([date])
  @@map("work_sessions")
}

model AdminActivityLog {
  id             String   @id @default(cuid())
  action         String   // EMPLOYEE_LOGIN, EMPLOYEE_LOGOUT, VIEW_REPORTS, EXPORT_DATA, etc
  
  submitterId    String
  submitter      User     @relation("ActivitySubmitter", fields: [submitterId], references: [id], onDelete: Cascade)
  
  employeeId     String?
  email          String?
  department     String?
  
  details        String   @db.Text
  timestamp      DateTime @default(now())
  status         String   @default("SUCCESS") // SUCCESS, FAILED, PENDING
  errorMessage   String?
  
  ipAddress      String?
  userAgent      String?
  
  createdAt      DateTime @default(now())

  @@index([action])
  @@index([submitterId])
  @@index([employeeId])
  @@index([timestamp])
  @@map("admin_activity_logs")
}

model AttendanceReport {
  id               String   @id @default(cuid())
  employeeId       String
  email            String
  department       String
  
  date             DateTime
  presentDays      Int
  absentDays       Int
  totalHours       Float
  attendanceRate   Float
  
  monthYear        String   // "2025-11" for November 2025
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([employeeId, date])
  @@index([employeeId])
  @@index([date])
  @@index([monthYear])
  @@map("attendance_reports")
}

model DepartmentStats {
  id               String   @id @default(cuid())
  department       String   @unique
  totalEmployees   Int
  averageHours     Float
  onlineNow        Int
  performanceScore Float?
  
  date             DateTime @default(now())
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([date])
  @@index([department])
  @@map("department_stats")
}

// ==================== VISITOR TRACKING SYSTEM ====================

model Visitor {
  id                String        @id @default(uuid())
  visitorId         String        @unique // Unique identifier (cookie/fingerprint)
  
  // Identity Information
  type              VisitorType   @default(ANONYMOUS)
  status            VisitorStatus @default(ACTIVE)
  email             String?
  name              String?
  phone             String?
  company           String?
  position          String?
  
  // Device & Location
  ipAddress         String
  country           String?
  city              String?
  region            String?
  timezone          String?
  language          String?
  
  // Device Information
  device            String?       // Desktop, Mobile, Tablet
  os                String?       // Windows, Mac, Linux, iOS, Android
  browser           String?       // Chrome, Firefox, Safari, Edge
  browserVersion    String?
  screenResolution  String?
  userAgent         String        @db.Text
  
  // Tracking Data
  firstVisit        DateTime      @default(now())
  lastVisit         DateTime      @default(now())
  totalVisits       Int           @default(1)
  totalPageViews    Int           @default(0)
  totalTimeSpent    Int           @default(0) // in seconds
  
  // Marketing
  referrer          String?       @db.Text
  utmSource         String?
  utmMedium         String?
  utmCampaign       String?
  utmTerm           String?
  utmContent        String?
  
  // Engagement
  pagesVisited      String[]      // Array of page URLs
  actionsPerformed  String[]      // Array of actions (click, scroll, etc)
  interests         String[]      // Based on pages visited
  
  // Lead Scoring
  leadScore         Int           @default(0)
  isQualified       Boolean       @default(false)
  
  // Relations
  sessions          VisitorSession[]
  pageViews         PageView[]
  events            VisitorEvent[]
  forms             FormSubmission[]
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  @@index([visitorId])
  @@index([email])
  @@index([ipAddress])
  @@index([status])
  @@index([type])
  @@index([firstVisit])
  @@index([lastVisit])
  @@map("visitors")
}

model VisitorSession {
  id                String        @id @default(uuid())
  visitorId         String
  visitor           Visitor       @relation(fields: [visitorId], references: [id], onDelete: Cascade)
  
  sessionId         String        @unique
  
  // Session Details
  startTime         DateTime      @default(now())
  endTime           DateTime?
  duration          Int?          // in seconds
  isActive          Boolean       @default(true)
  
  // Entry & Exit
  entryPage         String
  exitPage          String?
  
  // Device Info (can change between sessions)
  ipAddress         String
  device            String?
  browser           String?
  os                String?
  
  // Session Metrics
  pageViews         Int           @default(0)
  events            Int           @default(0)
  scrollDepth       Float?        // percentage
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  @@index([visitorId])
  @@index([sessionId])
  @@index([isActive])
  @@index([startTime])
  @@map("visitor_sessions")
}

model PageView {
  id                String        @id @default(uuid())
  visitorId         String
  visitor           Visitor       @relation(fields: [visitorId], references: [id], onDelete: Cascade)
  
  // Page Details
  url               String        @db.Text
  title             String?
  path              String
  referrer          String?       @db.Text
  
  // Timing
  timestamp         DateTime      @default(now())
  timeOnPage        Int?          // seconds
  scrollDepth       Float?        // percentage
  
  // Interactions
  clicks            Int           @default(0)
  formInteractions  Int           @default(0)
  
  createdAt         DateTime      @default(now())
  
  @@index([visitorId])
  @@index([url])
  @@index([path])
  @@index([timestamp])
  @@map("page_views")
}

model VisitorEvent {
  id                String        @id @default(uuid())
  visitorId         String
  visitor           Visitor       @relation(fields: [visitorId], references: [id], onDelete: Cascade)
  
  // Event Details
  eventType         String        // click, scroll, hover, download, video_play, etc
  eventCategory     String?       // button, link, form, video, etc
  eventLabel        String?       // Specific element identifier
  eventValue        String?       @db.Text
  
  // Context
  page              String
  element           String?       // CSS selector or element description
  
  timestamp         DateTime      @default(now())
  
  @@index([visitorId])
  @@index([eventType])
  @@index([timestamp])
  @@map("visitor_events")
}

model FormSubmission {
  id                String        @id @default(uuid())
  visitorId         String
  visitor           Visitor       @relation(fields: [visitorId], references: [id], onDelete: Cascade)
  
  // Form Details
  formType          String        // contact, newsletter, quote, demo, etc
  formName          String?
  page              String
  
  // Submitted Data
  email             String?
  name              String?
  phone             String?
  company           String?
  message           String?       @db.Text
  customFields      Json?         // Additional fields
  
  // Status
  isProcessed       Boolean       @default(false)
  isSpam            Boolean       @default(false)
  respondedAt       DateTime?
  
  submittedAt       DateTime      @default(now())
  createdAt         DateTime      @default(now())
  
  @@index([visitorId])
  @@index([formType])
  @@index([email])
  @@index([submittedAt])
  @@map("form_submissions")
}

model LiveVisitor {
  id                String        @id @default(uuid())
  visitorId         String        @unique
  
  // Current Activity
  currentPage       String
  pageTitle         String?
  isActive          Boolean       @default(true)
  
  // Visitor Info
  email             String?
  name              String?
  ipAddress         String
  country           String?
  city              String?
  device            String?
  browser           String?
  
  // Timing
  lastActivityAt    DateTime      @default(now())
  sessionStart      DateTime      @default(now())
  timeOnSite        Int           @default(0) // seconds
  
  // Metrics
  pageViews         Int           @default(0)
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  @@index([visitorId])
  @@index([isActive])
  @@index([lastActivityAt])
  @@map("live_visitors")
}

model VisitorAnalytics {
  id                String        @id @default(uuid())
  date              DateTime      @unique @default(now())
  
  // Daily Metrics
  totalVisitors     Int           @default(0)
  newVisitors       Int           @default(0)
  returningVisitors Int           @default(0)
  
  totalPageViews    Int           @default(0)
  avgTimeOnSite     Float         @default(0)
  bounceRate        Float         @default(0)
  
  // Conversions
  formSubmissions   Int           @default(0)
  leadsGenerated    Int           @default(0)
  
  // Top Pages
  topPages          Json?
  topReferrers      Json?
  topCountries      Json?
  topDevices        Json?
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  @@index([date])
  @@map("visitor_analytics")
}

// ==================== APPROVAL SYSTEM ====================

model Approval {
  id              String           @id @default(uuid())
  approvalId      String           @unique
  type            ApprovalType
  title           String
  description     String?          @db.Text
  amount          String?
  status          ApprovalStatus   @default(PENDING)
  priority        ApprovalPriority @default(MEDIUM)
  
  // Submitter info
  submitterId     String
  submitter       User             @relation("ApprovalSubmitter", fields: [submitterId], references: [id], onDelete: Cascade)
  submitterName   String
  submitterEmail  String
  submitterAvatar String?
  
  // Approver info
  approverId      String?
  approver        User?            @relation("ApprovalApprover", fields: [approverId], references: [id], onDelete: SetNull)
  approverName    String?
  approverEmail   String?
  approverAvatar  String?
  
  // Additional fields
  notes           String?          @db.Text
  metadata        Json?            // Store additional structured data
  attachments     String[]         // Array of file URLs
  
  // Dates
  submittedDate   DateTime         @default(now())
  approvedDate    DateTime?
  dueDate         DateTime?
  
  // Timestamps
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  // Relations
  comments        ApprovalComment[]
  history         ApprovalHistory[]
  
  @@index([submitterId])
  @@index([approverId])
  @@index([status])
  @@index([type])
  @@index([priority])
  @@index([submittedDate])
  @@index([approvalId])
  @@map("approvals")
}

model ApprovalComment {
  id         String   @id @default(uuid())
  approvalId String
  approval   Approval @relation(fields: [approvalId], references: [id], onDelete: Cascade)
  
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  comment    String   @db.Text
  isInternal Boolean  @default(false) // Internal comments visible only to admins
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@index([approvalId])
  @@index([userId])
  @@map("approval_comments")
}

model ApprovalHistory {
  id         String   @id @default(uuid())
  approvalId String
  approval   Approval @relation(fields: [approvalId], references: [id], onDelete: Cascade)
  
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  action     String   // CREATED, UPDATED, APPROVED, REJECTED, COMMENTED, etc.
  oldValue   String?  @db.Text
  newValue   String?  @db.Text
  changes    Json?    // Structured change data
  
  createdAt  DateTime @default(now())
  
  @@index([approvalId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("approval_history")
}

// ==================== CONTENT MANAGEMENT SYSTEM ====================

model Content {
  id              String        @id @default(uuid())
  title           String
  slug            String        @unique
  excerpt         String?       @db.Text
  content         String        @db.Text
  type            ContentType   @default(BLOG)
  status          ContentStatus @default(DRAFT)
  featured        Boolean       @default(false)
  featuredImage   String?
  
  // Category relation
  categoryId      String?
  category        Category?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  
  // Publishing
  publishedAt     DateTime?
  scheduledAt     DateTime?
  
  // SEO
  metaTitle       String?
  metaDescription String?
  metaKeywords    String?
  
  // Analytics
  views           Int           @default(0)
  readTime        Int?          // in minutes
  likes           Int           @default(0)
  comments        Int           @default(0)
  shares          Int           @default(0)
  
  // Author
  authorId        String
  author          User          @relation("ContentAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  tags            Tag[]         @relation("ContentTags")
  commentsList    Comment[]
  media           Media[]       @relation("ContentMedia")
  contentLikes    ContentLike[]
  contentShares   ContentShare[]
  
  @@index([slug])
  @@index([type])
  @@index([status])
  @@index([authorId])
  @@index([categoryId])
  @@index([publishedAt])
  @@map("content")
}

model Category {
  id          String    @id @default(uuid())
  name        String    @unique
  slug        String    @unique
  description String?
  icon        String?
  color       String?
  order       Int       @default(0)
  parent      String?
  active      Boolean   @default(true)
  
  content     Content[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([slug])
  @@index([active])
  @@map("categories")
}

model Media {
  id            String    @id @default(uuid())
  title         String
  description   String?
  type          MediaType
  url           String
  thumbnailUrl  String?
  size          String?
  duration      String?
  dimensions    String?
  folder        String    @default("root")
  public        Boolean   @default(false)
  
  // Analytics
  views         Int       @default(0)
  downloads     Int       @default(0)
  
  // Upload info
  uploadedById  String
  uploadedBy    User      @relation("MediaUploader", fields: [uploadedById], references: [id], onDelete: Cascade)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  tags          Tag[]     @relation("MediaTags")
  contentId     String?
  content       Content?  @relation("ContentMedia", fields: [contentId], references: [id], onDelete: SetNull)
  
  @@index([type])
  @@index([uploadedById])
  @@index([folder])
  @@map("media")
}

model Tag {
  id        String    @id @default(uuid())
  name      String    @unique
  slug      String    @unique
  color     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  // Relations
  content   Content[] @relation("ContentTags")
  media     Media[]   @relation("MediaTags")
  
  @@index([slug])
  @@map("tags")
}

model Comment {
  id        String   @id @default(uuid())
  contentId String
  content   Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  
  authorId  String
  author    User     @relation("CommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  
  text      String   @db.Text
  approved  Boolean  @default(false)
  
  parentId  String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([contentId])
  @@index([authorId])
  @@index([approved])
  @@map("comments")
}

model ContentLike {
  id        String   @id @default(uuid())
  contentId String
  content   Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([contentId, userId])
  @@index([contentId])
  @@index([userId])
  @@map("content_likes")
}

model ContentShare {
  id        String   @id @default(uuid())
  contentId String
  content   Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  
  platform  String   // facebook, twitter, linkedin, email, etc.
  ipAddress String?
  userAgent String?
  
  createdAt DateTime @default(now())
  
  @@index([contentId])
  @@index([platform])
  @@map("content_shares")
}

// ==================== OTHER MODELS ====================

model Division {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  sicCode     String
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("divisions")
}

model ContactSubmission {
  id        String   @id @default(uuid())
  name      String
  email     String
  phone     String?
  subject   String?
  message   String   @db.Text
  responded Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([responded])
  @@index([createdAt])
  @@map("contact_submissions")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  entity    String
  entityId  String?
  changes   String?  @db.Text
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}